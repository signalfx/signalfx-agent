image: Visual Studio 2017
version: "{build}"
clone_folder: c:\gopath\src\github.com\signalfx\signalfx-agent
environment:
  AGENT_BIN: c:\gopath\src\github.com\signalfx\signalfx-agent\signalfx-agent.exe
  AGENT_VERSION: 3.4.1
  GOPATH: c:\gopath
  PYTHONPATH: C:\Python35-x64
  TEST_SERVICES_DIR: c:\gopath\src\github.com\signalfx\signalfx-agent\test-services
install:
  - set PATH=%GOPATH%\bin;c:\go\bin;%PYTHONPATH%;%PATH%
  - go version
  - go env
  - go get github.com/golang/lint/golint
  - go get github.com/tebeka/go2xunit
  - python --version
  - curl -Lo get-pip.py https://bootstrap.pypa.io/get-pip.py
  - python get-pip.py "pip==10.0.1"
  - pip install -r tests\requirements.txt
  - pip list
build:
  verbosity: minimal
before_build:
  - echo "Running go lint"
  - ps: "& { . $env:APPVEYOR_BUILD_FOLDER/scripts/windows/make.ps1; lint }"
  - echo "Running go vet"
  - ps: "& { . $env:APPVEYOR_BUILD_FOLDER/scripts/windows/make.ps1; vet }"
build_script:
  - echo "Running go build"
  - ps: "& { . $env:APPVEYOR_BUILD_FOLDER/scripts/windows/make.ps1; signalfx-agent $env:AGENT_VERSION }"
test_script:
  - echo "Running unit tests"
  - ps: "& { . $env:APPVEYOR_BUILD_FOLDER/scripts/windows/make.ps1; $env:TEST_RC=test }"
  - ps: |
      $wc = New-Object 'System.Net.WebClient'
      $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path .\results.xml))
  - ps: if ($env:TEST_RC -ne 0){ echo "One or more tests failed!"; exit $env:TEST_RC }
  - echo "Running integration tests"
  - pytest -n4 -m "not packaging and not installer and not k8s" --verbose --junitxml=testresults/integration_tests.xml --html=testresults/integration_tests.html --self-contained-html tests
deploy: off
