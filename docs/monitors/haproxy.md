<!--- GENERATED BY gomplate from scripts/docs/monitor-page.md.tmpl --->

# haproxy

Monitor Type: `haproxy` ([Source](https://github.com/signalfx/signalfx-agent/tree/master/internal/monitors/haproxy))

**Accepts Endpoints**: **Yes**

**Multiple Instances Allowed**: Yes

## Overview

This monitor scrapes [HAProxy](http://www.haproxy.org/) statistics from an HTTP endpoint or a UNIX socket.
It requires HAProxy 1.8+ and supports running HAProxy in multi-process mode where the HAProxy process each
metric pertains to is indicated by the metric dimension `process_num`.

<!--- SETUP --->
### HTTP Endpoint Config
HAProxy stats must be enabled as described [here](https://www.haproxy.com/blog/exploring-the-haproxy-stats-page/).
Define the HAProxy monitor in the agent configuration file and provide the `csv export` URL where HAProxy
stats are served in CSV format. This monitor supports basic HTTP authentication. Simply provide the
username and password if required as shown below:
```
...
monitors:
  - type: haproxy
    url: "http://localhost:8404/stats?stats;csv"
    username: "your username here"
    password: "your password here"
...
```
Note: The HAProxy process level stats given by the [show info](https://cbonte.github.io/haproxy-dconv/1.8/management.html#9.3-show%20info) command
are not available at the HTTP endpoint. Scrape stats from the UNIX socket instead to include the `show info`
command metrics.

### UNIX Socket Config
The location of the HAProxy socket file is defined in the HAProxy config file, as in the following example:
```
global
    daemon
    stats socket /var/run/haproxy.sock
    stats timeout 2m
```
For the given location of the socket file, configure the HAProxy monitor URL as shown below:
```
...
monitors:
  - type: haproxy
    url: "unix:/var/run/haproxy.sock"
...
```
Note: The agent process needs read/write permissions to the HAProxy socket file.


## Configuration

To activate this monitor in the Smart Agent, add the following to your
agent config:

```
monitors:  # All monitor config goes under this key
 - type: haproxy
   ...  # Additional config
```

**For a list of monitor options that are common to all monitors, see [Common
Configuration](../monitor-config.md#common-configuration).**


| Config option | Required | Type | Description |
| --- | --- | --- | --- |
| `username` | no | `string` | Basic Auth username to use on each request, if any. |
| `password` | no | `string` | Basic Auth password to use on each request, if any. |
| `url` | **yes** | `string` | URL on which to scrape HAProxy. |
| `sslVerify` | no | `bool` | Flag that enables SSL certificate verification for the scrape URI. (**default:** `true`) |
| `timeout` | no | `int64` | Timeout for trying to get stats from HAProxy. This should be a duration string that is accepted by https://golang.org/pkg/time/#ParseDuration (**default:** `5s`) |
| `proxiesToMonitor` | no | `list of strings` | A list of the pxname(s) and svname(s) to monitor (e.g. `["http-in", "server1", "backend"]`). If empty then metrics of all proxies will be reported. |


## Metrics

These are the metrics available for this monitor.
Metrics that are categorized as
[container/host](https://docs.signalfx.com/en/latest/admin-guide/usage.html#about-custom-bundled-and-high-resolution-metrics)
(*default*) are ***in bold and italics*** in the list below.


 - `counter.connection_total` (*cumulative*)<br>    Cumulative number of connections. Values reported for frontends.
 - ***`counter.server_selected_total`*** (*cumulative*)<br>    Total number of times a server was selected, either for new sessions, or when re-dispatching. The server counter is the number of times that server was selected. Values reported for backends and servers.
 - ***`derive.bytes_in`*** (*cumulative*)<br>    Total number of incoming bytes. Values reported for listeners, frontends, backends, and servers.
 - ***`derive.bytes_out`*** (*cumulative*)<br>    Total number of outgoing bytes. Values reported for listeners, frontends, backends, and servers.
 - `derive.cli_abrt` (*cumulative*)<br>    Number of data transfers aborted by the client. Values reported for backends and servers.
 - `derive.comp_byp` (*cumulative*)<br>    Number of bytes that bypassed the HTTP compressor (CPU/BW limit). Values reported for frontends and backends.
 - `derive.comp_in` (*cumulative*)<br>    Number of HTTP response bytes fed to the compressor. Values reported for frontends and backends.
 - `derive.comp_out` (*cumulative*)<br>    Number of HTTP response bytes emitted by the compressor. Values reported for frontends and backends.
 - `derive.comp_rsp` (*cumulative*)<br>    Number of HTTP responses that were compressed. Values reported for frontends and backends.
 - ***`derive.denied_request`*** (*cumulative*)<br>    Number of requests denied because of security concerns. For tcp this is because of a matched tcp-request content rule. For http this is because of a matched http-request or tarpit rule. Values reported for listeners, frontends, and backends.
 - ***`derive.denied_response`*** (*cumulative*)<br>    Number of responses denied because of security concerns. For http this is because of a matched http-request rule, or "option checkcache". Values reported for listeners, frontends, backends, and servers.
 - `derive.downtime` (*cumulative*)<br>    Total downtime (in seconds). The value for the backend is the downtime for the whole backend, not the sum of the server downtime. Values reported for backends and servers.
 - ***`derive.error_connectiont`*** (*cumulative*)<br>    Number of requests that encountered an error trying to connect to a backend server. The backend stat is the sum of the stat for all servers of that backend, plus any connection errors not associated with a particular server (such as the backend having no active servers). Values reported for backends and servers.
 - ***`derive.error_request`*** (*cumulative*)<br>    Number of request errors. Some of the possible causes are: early termination from the client, before the request has been sent, read error from the client, client timeout, client closed connection, various bad requests from the client, request was tarpitted. Values reported for listeners and frontends.
 - ***`derive.error_response`*** (*cumulative*)<br>    Number of response errors. srv_abrt will be counted here also. Some other errors are: write error on the client socket (won't be counted for the server stat), failure applying filters to the response. Values reported for backends and servers.
 - `derive.failed_checks` (*cumulative*)<br>    Number of failed checks. (Only counts checks failed when the server is up.). Values reported for servers.
 - ***`derive.redispatched`*** (*cumulative*)<br>    Number of times a request was redispatched to another server. The server value counts the number of times that server was switched away from. Values reported for backends and servers.
 - `derive.request_total` (*cumulative*)<br>    Total number of HTTP requests received. Values reported for frontends and backends.
 - `derive.response_1xx` (*cumulative*)<br>    HTTP responses with 1xx code. Values reported for frontends, backends, and servers.
 - ***`derive.response_2xx`*** (*cumulative*)<br>    HTTP responses with 2xx code. Values reported for frontends, backends, and servers.
 - `derive.response_3xx` (*cumulative*)<br>    HTTP responses with 3xx code. Values reported for frontends, backends, and servers.
 - ***`derive.response_4xx`*** (*cumulative*)<br>    HTTP responses with 4xx code. Values reported for frontends, backends, and servers.
 - ***`derive.response_5xx`*** (*cumulative*)<br>    HTTP responses with 5xx code. Values reported for frontends, backends, and servers.
 - `derive.response_other` (*cumulative*)<br>    HTTP responses with other codes (protocol error). Values reported for frontends, backends, and servers.
 - ***`derive.retries`*** (*cumulative*)<br>    Number of times a connection to a server was retried. Values reported for backends and servers.
 - `derive.session_total` (*cumulative*)<br>    The cumulative number of sessions. Values reported for listeners, frontends, backends, and servers.
 - `derive.srv_abrt` (*cumulative*)<br>    Number of data transfers aborted by the server (inc. in eresp). Values reported for backends and servers.
 - `gauge.active_servers` (*gauge*)<br>    Number of active servers (backend), server is active (server). Values reported for backends and servers.
 - `gauge.backup_servers` (*gauge*)<br>    Number of backup servers (backend), server is backup (server). Values reported for backends and servers.
 - `gauge.check_duration` (*gauge*)<br>    Time in ms took to finish last health check. Values reported for servers.
 - ***`gauge.connection_rate`*** (*gauge*)<br>    Number of connections over the last elapsed second. Values reported for frontends.
 - `gauge.connection_rate_max` (*gauge*)<br>    Highest known conn_rate. Values reported for frontends.
 - `gauge.denied_tcp_connections` (*gauge*)<br>    Requests denied by "tcp-request connection" rules. Values reported for listeners and frontends.
 - `gauge.denied_tcp_sessions` (*gauge*)<br>    Requests denied by "tcp-request session" rules. Values reported for listeners and frontends.
 - `gauge.intercepted_requests` (*gauge*)<br>    Cumulative cum. number of intercepted requests (monitor, stats). Values reported for frontends and backends.
 - `gauge.last_session` (*gauge*)<br>    Number of seconds since last session assigned to server/backend. Values reported for backends and servers.
 - ***`gauge.queue_current`*** (*gauge*)<br>    Number of current queued requests. For the backend this reports the number queued without a server assigned. Values reported for backends and servers.
 - `gauge.queue_limit` (*gauge*)<br>    Configured maxqueue for the server, or nothing in the value is 0 (default, meaning no limit). Values reported for servers.
 - `gauge.queue_max` (*gauge*)<br>    The max value of qcur. Values reported for backends and servers.
 - `gauge.queue_time_avg` (*gauge*)<br>    The average queue time in ms over the 1024 last requests. Values reported for backends and servers.
 - ***`gauge.request_rate`*** (*gauge*)<br>    HTTP requests per second over last elapsed second. Values reported for frontends.
 - `gauge.request_rate_max` (*gauge*)<br>    Max number of HTTP requests per second observed. Values reported for frontends.
 - `gauge.response_time_avg` (*gauge*)<br>    The average response time in ms over the 1024 last requests (0 for TCP). Values reported for backends and servers.
 - ***`gauge.session_current`*** (*gauge*)<br>    Number current sessions. Values reported for listeners, frontends, backends, and servers.
 - ***`gauge.session_rate`*** (*gauge*)<br>    Number of sessions per second over last elapsed second. Values reported for frontends, backends, and servers.
 - `gauge.session_rate_limit` (*gauge*)<br>    Configured limit on new sessions per second. Values reported for frontends.
 - `gauge.session_rate_max` (*gauge*)<br>    Max number of new sessions per second. Values reported for frontends, backends, and servers.
 - `gauge.session_time_average` (*gauge*)<br>    The average total session time in ms over the 1024 last requests. Values reported for backends and servers.
 - `gauge.throttle` (*gauge*)<br>    Current throttle percentage for the server, when slowstart is active, or no value if not in slowstart. Values reported for servers.

#### Group showInfoCmd
All of the following metrics are part of the `showInfoCmd` metric group. All of
the non-default metrics below can be turned on by adding `showInfoCmd` to the
monitor config option `extraGroups`:
 - `derive.compress_bps_in` (*cumulative*)<br>    Corresponds to the current HAProxy process `CompressBpsIn` value given by the `show info` cmd.
 - `derive.compress_bps_out` (*cumulative*)<br>    Corresponds to the current HAProxy process `CompressBpsOut` value given by the `show info` cmd.
 - `derive.connections` (*cumulative*)<br>    Corresponds to the current HAProxy process `CumConns` value given by the `show info` cmd. Cumulative number of connections.
 - ***`derive.requests`*** (*cumulative*)<br>    Corresponds to the current HAProxy process `CumReq` value given by the `show info` cmd.
 - `derive.ssl_cache_lookups` (*cumulative*)<br>    Corresponds to the current HAProxy process `SslCacheLookups` value given by the `show info` cmd.
 - `derive.ssl_cache_misses` (*cumulative*)<br>    Corresponds to the current HAProxy process `SslCacheMisses` value given by the `show info` cmd.
 - `derive.ssl_connections` (*cumulative*)<br>    Corresponds to the current HAProxy process `CumSslConns` value given by the `show info` cmd.
 - `derive.uptime_seconds` (*cumulative*)<br>    Corresponds to the current HAProxy process `Uptime_sec` value given by the `show info` cmd.
 - `gauge.current_connections` (*gauge*)<br>    Corresponds to the current HAProxy process `CurrConns` value given by the `show info` cmd.
 - `gauge.current_ssl_connections` (*gauge*)<br>    Corresponds to the current HAProxy process `CurrSslConns` value given by the `show info` cmd.
 - ***`gauge.idle_pct`*** (*gauge*)<br>    Corresponds to the current HAProxy process `Idle_pct` value given by the `show info` cmd. Ratio of system polling time versus total time.
 - `gauge.max_connection_rate` (*gauge*)<br>    Corresponds to the current HAProxy process `MaxConnRate` value given by the `show info` cmd.
 - `gauge.max_connections` (*gauge*)<br>    Corresponds to the current HAProxy process `MaxConn` value given by the `show info` cmd.
 - `gauge.max_pipes` (*gauge*)<br>    Corresponds to the current HAProxy process `MaxPipes` value given by the `show info` cmd.
 - `gauge.max_session_rate` (*gauge*)<br>    Corresponds to the current HAProxy process `MaxSessRate` value given by the `show info` cmd.
 - `gauge.max_ssl_connections` (*gauge*)<br>    Corresponds to the current HAProxy process `MaxSslConns` value given by the `show info` cmd.
 - `gauge.pipes_free` (*gauge*)<br>    Corresponds to the current HAProxy process `PipesFree` value given by the `show info` cmd.
 - `gauge.pipes_used` (*gauge*)<br>    Corresponds to the current HAProxy process `PipesUsed` value given by the `show info` cmd.
 - `gauge.run_queue` (*gauge*)<br>    Corresponds to the current HAProxy process `Run_queue` value given by the `show info` cmd.
 - `gauge.session_rate_all` (*gauge*)<br>    Corresponds to the current HAProxy process `SessRate` value given by the `show info` cmd.
 - `gauge.ssl_backend_key_rate` (*gauge*)<br>    Corresponds to the current HAProxy process `SslBackendKeyRate` value given by the `show info` cmd.
 - `gauge.ssl_frontend_key_rate` (*gauge*)<br>    Corresponds to the current HAProxy process `SslFrontendKeyRate` value given by the `show info` cmd.
 - `gauge.ssl_rate` (*gauge*)<br>    Corresponds to the current HAProxy process `SslRate` value given by the `show info` cmd.
 - `gauge.tasks` (*gauge*)<br>    Corresponds to the current HAProxy process `Tasks` value given by the `show info` cmd.
 - `gauge.zlib_mem_usage` (*gauge*)<br>    Corresponds to the current HAProxy process `ZlibMemUsage` value given by the `show info` cmd.

### Non-default metrics (version 4.7.0+)

**The following information applies to the agent version 4.7.0+ that has
`enableBuiltInFiltering: true` set on the top level of the agent config.**

To emit metrics that are not _default_, you can add those metrics in the
generic monitor-level `extraMetrics` config option.  Metrics that are derived
from specific configuration options that do not appear in the above list of
metrics do not need to be added to `extraMetrics`.

To see a list of metrics that will be emitted you can run `agent-status
monitors` after configuring this monitor in a running agent instance.

### Legacy non-default metrics (version < 4.7.0)

**The following information only applies to agent version older than 4.7.0. If
you have a newer agent and have set `enableBuiltInFiltering: true` at the top
level of your agent config, see the section above. See upgrade instructions in
[Old-style whitelist filtering](../legacy-filtering.md#old-style-whitelist-filtering).**

If you have a reference to the `whitelist.json` in your agent's top-level
`metricsToExclude` config option, and you want to emit metrics that are not in
that whitelist, then you need to add an item to the top-level
`metricsToInclude` config option to override that whitelist (see [Inclusion
filtering](../legacy-filtering.md#inclusion-filtering).  Or you can just
copy the whitelist.json, modify it, and reference that in `metricsToExclude`.

## Dimensions

The following dimensions may occur on metrics emitted by this monitor.  Some
dimensions may be specific to certain metrics.

| Name | Description |
| ---  | ---         |
| `process_num` | A number assigned to an HAProxy process instance (0 for first instance, 1 for second, ...). |
| `proxy_name` | HAProxy configured proxy name. Possible values for listeners, frontends, backends, and servers. |
| `service_name` | HAProxy configured service name. Possible values are FRONTEND for frontend, BACKEND for backend, configured name for server/listener. |



