<?xml version="1.0"?>
<?define ProductVersion = "$(env.PRODUCT_VERSION)"?>
<?define IconPath = "$(env.ICON_PATH)"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*" UpgradeCode="328012a7-4036-4a2b-94a5-2936ff1edcbd" Name="SignalFx Smart Agent" Version="$(var.ProductVersion)" Manufacturer="SignalFx, Inc." Language="1033">
    <Package InstallerVersion="200" Platform="x64" Compressed="yes" Comments="Windows Installer Package"/>
    <MajorUpgrade Schedule="afterInstallInitialize" AllowDowngrades="yes"/>
    <Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>
    <Icon Id="ProductIcon" SourceFile="$(var.IconPath)"/>

    <Property Id="ARPPRODUCTICON" Value="ProductIcon"/>
    <Property Id="ARPHELPLINK" Value="https://www.signalfx.com"/>
    <Property Id="ARPURLINFOABOUT" Value="https://www.signalfx.com"/>
    <Property Id="ARPNOREPAIR" Value="1"/>
    <Property Id="ARPNOMODIFY" Value="1"/>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="COMPANYDIR" Name="SignalFx">
          <Directory Id="INSTALLDIR" Name="SignalFxAgent"/>
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="SignalFxAgent" Level="1">
      <!-- list of files auto-generated by heat at build time -->
      <ComponentGroupRef Id="SignalFxAgent"/>
    </Feature>

    <CustomAction Id="StopService" Return="ignore" Impersonate="yes" Execute="deferred" Directory="INSTALLDIR" ExeCommand='[INSTALLDIR]bin\signalfx-agent.exe -service "stop"'/>
    <CustomAction Id="UninstallService" Return="ignore" Impersonate="yes" Execute="deferred" Directory="INSTALLDIR" ExeCommand='[INSTALLDIR]bin\signalfx-agent.exe -service "uninstall"'/>

    <InstallExecuteSequence>
      <!-- agent service to be installed and started by installer script since it is dependent on agent.yaml and token -->
      <!-- try to stop and uninstall agent service on package upgrade/uninstall -->
      <Custom Action="StopService" Before="RemoveFiles">UPGRADINGPRODUCTCODE OR (REMOVE="ALL")</Custom>
      <Custom Action="UninstallService" After="StopService">UPGRADINGPRODUCTCODE OR (REMOVE="ALL")</Custom>
    </InstallExecuteSequence>
  </Product>
</Wix>
