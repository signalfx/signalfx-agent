# Frequently Asked Questions

- [How does this differ from the old collectd agent?](#how-does-this-differ-from-the-old-collectd-agent)
- [What if I am currently using the old collectd agent?](#what-if-I-am-currently-using-the-old-collectd-agent)
- [How can I see the datapoints emitted by the agent to troubleshoot issues?](#how-can-I-see-the-datapoints-emitted-by-the-agent-to-troubleshoot-issues)
- [How can I see what services the agent has discovered?](#how-can-I-see-what-services-the-agent-has-discovered)
- [Why do other pods in my Kubernetes cluster get stuck terminating?](#why-do-other-pods-in-my-kubernetes-cluster-get-stuck-terminating)


## How does this differ from the old collectd agent?

Upon its initial release, the new agent, called the SignalFx SmartAgent, is
essentially a wrapper application around collectd that adds service discovery
and automatic configuration of collectd based on those discovered services.
Most of the system metrics are generated by collectd, as well as most
application metrics. Configuration of collectd monitors is largely a
passthrough to collectd config options, but in a YAML format instead of the
collectd custom syntax.

The first main foray outside of collectd was the Kubernetes integration, which
uses monitors and observers written purely in Go and run completely independent
of collectd.  We hope to write additional monitors apart from collectd, and
perhaps eventually remove the dependency on collectd entirely.

## What if I am currently using the old collectd agent?

The Smart Agent comes with all of its dependencies bundled, so you will not
need a prior collectd installation. If you are using the old collectd agent,
you should uninstall it first before installing the Smart Agent.  **Make sure
the old collectd instance does not run alongside the new agent, or you might
send duplicate datapoints and use unnecessary DPM (datapoints per minute).**

If you have your own homegrown collectd plugins, you can still use these with
the Smart Agent by using the [collectd/custom](./monitors/collectd-custom.md)
monitor.  You can reuse your original collectd `managed_config` directory's
configuration files by adding the following monitor:

```yaml
monitors:
  - type: collectd/custom
    templates: {"#from": "/etc/collectd/managed_config/*.conf", raw: true}
```

We run collectd-python linked against Python 2.7 so any Python plugins will
have to be Python 2.7 compatible.

## How can I see the datapoints emitted by the agent to troubleshoot issues?

Set the following config in the agent.yaml config file:

```yaml
logging:
  level: debug
writer:
  logDatapoints: true
```

This will log all of the datapoints as they are emitted by the agent.

## How can I see what services the agent has discovered?

Run the following command on the host with the agent. (If you are using the
containerized agent, you don't need to use `sudo`.)

```sh
$ sudo signalfx-agent status
```

This command dumps out some text that includes a section listing the discovered
service endpoints that the agent knows about.

## Why do other pods in my Kubernetes cluster get stuck terminating?

When running the agent in K8s, we have seen issues where the prescribed host
filesystem mount to `/hostfs` inside the agent pod will prevent termination of
other pods on the same node.  It appears to be the same issue described in
https://bugzilla.redhat.com/show_bug.cgi?id=1437952 with fluentd containers.
The best thing to do in this case is to unmount docker/k8s related mounts
inside the agent container by using this container command in the DaemonSet for
the agent instead of the default `/bin/signalfx-agent`, as well by adding the
`SYS_ADMIN` capability to the agent container:

```yaml
...
      containers:
      - command:
        - /bin/bash
        - -c
        - /bin/umount-hostfs-non-persistent; exec /bin/signalfx-agent
        name: signalfx-agent
        securityContext:
          capabilities:
            add:
            - SYS_ADMIN
	    ...
	...
...
```

The source for the script `/bin/umount-hostfs-non-persistent` can be [found
here](https://github.com/signalfx/signalfx-agent/blob/master/scripts/umount-hostfs-non-persistent),
but basically it just does a `umount` on all of the potentially problematic
mounts that we know of.  You can add arguments to the script invocation for
additional directories to unmount if necessary.

Note that in order to unmount filesystems, you must have the `SYS_ADMIN`
capability.  Because it requires such a broad capability, we don't do the
unmounting by default in order to keep the agent's permissions limited.

We need to mount the host filesystem into the agent pod in order to get disk usage
metrics for each disk individually on the node, but unfortunately there is no
way to be more selective with what gets mounted by K8s.
